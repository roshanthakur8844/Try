<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Organism Runtime</title>

<style>
html,body{
  margin:0;
  background:#000;
  overflow:hidden;
  touch-action:none;
  font-family:monospace;
}
canvas{
  position:absolute;
  inset:0;
}
#ui{
  position:fixed;
  top:10px;left:10px;
  color:#00ffcc;
  font-size:12px;
  text-shadow:0 0 8px #00ffcc;
  z-index:10;
}
#scan{
  position:fixed;
  inset:0;
  background:#000;
  color:#0f0;
  font-size:12px;
  padding:16px;
  display:none;
  z-index:20;
  animation:flicker .12s infinite;
}
@keyframes flicker{50%{opacity:.92}}
</style>
</head>

<body>

<canvas id="world"></canvas>
<canvas id="distort" style="opacity:.07;mix-blend-mode:difference"></canvas>

<div id="ui">
  <div>ORGANISM: ACTIVE</div>
  <div id="stats">ENTITIES: 0</div>
  <div>Tap to interact</div>
</div>

<div id="scan"></div>

<script>
/* ================= CORE ================= */
const world = document.getElementById("world");
const ctx = world.getContext("2d");

const distort = document.getElementById("distort");
const dctx = distort.getContext("2d");

let W,H,DPR=Math.min(2,devicePixelRatio||1);
function resize(){
  W=innerWidth; H=innerHeight;
  [world,distort].forEach(c=>{
    c.width=W*DPR; c.height=H*DPR;
    c.style.width=W+"px"; c.style.height=H+"px";
    c.getContext("2d").setTransform(DPR,0,0,DPR,0,0);
  });
}
resize(); addEventListener("resize",resize);

/* ================= ENTITY AI ================= */
let entities=[];
class Entity{
  constructor(x,y){
    this.x=x; this.y=y;
    this.vx=0; this.vy=0;
    this.genome={
      size:Math.random()*18+10,
      hue:Math.random()*360,
      curiosity:Math.random(),
      aggression:Math.random()
    };
    this.energy=1;
  }
  update(){
    this.vx+=Math.sin(time*this.genome.curiosity+this.x*.01);
    this.vy+=Math.cos(time*this.genome.aggression+this.y*.01);

    this.vx+=gyroX*0.2;
    this.vy+=gyroY*0.2;

    this.x+=this.vx*0.2;
    this.y+=this.vy*0.2;

    if(this.x<0||this.x>W)this.vx*=-1;
    if(this.y<0||this.y>H)this.vy*=-1;

    this.energy-=0.0006;

    // Evolution
    if(this.energy<0 && Math.random()<0.03){
      this.energy=1;
      Object.keys(this.genome).forEach(k=>{
        this.genome[k]+= (Math.random()-0.5)*0.1;
      });
    }
  }
  draw(){
    ctx.fillStyle=`hsla(${this.genome.hue},100%,60%,${this.energy})`;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.genome.size,0,Math.PI*2);
    ctx.fill();

    if(Math.random()<0.005) drawGlyph(this.x,this.y);
  }
}

/* ================= GLYPHS ================= */
function drawGlyph(x,y){
  ctx.strokeStyle="#ff00ff";
  ctx.beginPath();
  for(let i=0;i<6;i++){
    ctx.lineTo(
      x+Math.sin(i+time*.02)*20,
      y+Math.cos(i+time*.02)*20
    );
  }
  ctx.stroke();
}

/* ================= CAMERA DISTORTION ================= */
let camStarted=false;
function startCamera(){
  if(camStarted) return;
  camStarted=true;

  navigator.mediaDevices.getUserMedia({video:true})
  .then(stream=>{
    const v=document.createElement("video");
    v.srcObject=stream; v.play();

    function camLoop(){
      dctx.clearRect(0,0,W,H);
      dctx.globalAlpha=0.08;
      dctx.drawImage(v,0,0,W,H);
      requestAnimationFrame(camLoop);
    }
    camLoop();
  })
  .catch(()=>{});
}

/* ================= AUDIO (SAFE) ================= */
let audioCtx, analyser, audioData;
function initAudio(){
  if(audioCtx) return;
  audioCtx=new AudioContext();
  analyser=audioCtx.createAnalyser();
  const osc=audioCtx.createOscillator();
  osc.frequency.value=40;
  osc.connect(analyser);
  analyser.connect(audioCtx.destination);
  osc.start();
  audioData=new Uint8Array(analyser.frequencyBinCount);
}

/* ================= FAKE MEMORY SCAN ================= */
function fakeScan(){
  const s=document.getElementById("scan");
  s.innerText="";
  s.style.display="block";
  let i=0;
  const t=setInterval(()=>{
    s.innerText+=`Scanning block ${i}...\n`;
    i++;
    if(i>25){
      clearInterval(t);
      s.innerText+="CORRUPTION DETECTED";
      setTimeout(()=>s.style.display="none",1200);
    }
  },45);
}

/* ================= GYRO ================= */
let gyroX=0,gyroY=0;
addEventListener("deviceorientation",e=>{
  gyroX=(e.gamma||0)/45;
  gyroY=(e.beta||0)/45;
});

/* ================= INPUT ================= */
world.addEventListener("pointerdown",e=>{
  startCamera();
  initAudio();
  if(Math.random()<0.3) fakeScan();
  for(let i=0;i<3;i++){
    entities.push(new Entity(
      e.clientX+(Math.random()-0.5)*30,
      e.clientY+(Math.random()-0.5)*30
    ));
  }
});

/* ================= LOOP ================= */
let time=0;
function loop(){
  ctx.fillStyle="rgba(0,0,0,.25)";
  ctx.fillRect(0,0,W,H);

  if(analyser){
    analyser.getByteFrequencyData(audioData);
    const amp=audioData[5]/255;
    entities.forEach(e=>e.genome.size+=amp*0.3);
  }

  entities=entities.filter(e=>e.energy>0);
  entities.forEach(e=>{e.update();e.draw();});

  document.getElementById("stats").textContent=
    "ENTITIES: "+entities.length;

  time++;
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
